// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  avatarUrl     String?
  emailVerified DateTime?
  mfaEnabled    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  companies     CompanyMember[]
  notifications Notification[]
  auditLogs     AuditLog[]

  @@map("users")
}

// ============================================
// COMPANY
// ============================================

enum EntityType {
  C_CORP
  S_CORP
  LLC
  PBC
  LP
  OTHER
}

model Company {
  id                  String     @id @default(cuid())
  legalName           String
  dba                 String?    // Doing Business As
  ein                 String?    // XX-XXXXXXX format
  entityType          EntityType
  stateOfIncorporation String
  formationDate       DateTime?
  fiscalYearEnd       String?    // e.g., "12-31"
  
  // Address
  streetAddress       String?
  city                String?
  state               String?
  zipCode             String?
  country             String     @default("US")
  
  // Branding
  logoUrl             String?
  website             String?
  description         String?
  
  // EDGAR Access
  edgarCik            String?    // 10-digit CIK
  edgarCcc            String?    // CCC (encrypted)
  edgarStatus         String?    @default("not_started") // not_started, pending, active
  
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relations
  members             CompanyMember[]
  teamMembers         TeamMember[]
  capTableEntries     CapTableEntry[]
  raises              Raise[]
  documents           Document[]

  @@map("companies")
}

enum CompanyRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

model CompanyMember {
  id        String      @id @default(cuid())
  userId    String
  companyId String
  role      CompanyRole @default(VIEWER)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("company_members")
}

// ============================================
// TEAM MEMBERS (Officers, Directors, Shareholders)
// ============================================

enum TeamMemberRole {
  OFFICER
  DIRECTOR
  SHAREHOLDER
  OFFICER_DIRECTOR
  ALL
}

model TeamMember {
  id                  String         @id @default(cuid())
  companyId           String
  name                String
  title               String?
  email               String?
  role                TeamMemberRole
  ownershipPercentage Decimal?       @db.Decimal(5, 2) // For 20%+ shareholders
  
  // Bad Actor Check
  badActorStatus      String         @default("pending") // pending, cleared, flagged
  badActorCompletedAt DateTime?
  
  // Sensitive data (encrypted in application layer)
  ssnEncrypted        String?
  
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  company             Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  badActorResponses   BadActorResponse[]

  @@map("team_members")
}

model BadActorResponse {
  id           String     @id @default(cuid())
  teamMemberId String
  questionId   String     // Reference to question number
  response     Boolean    // Yes = true (potential issue), No = false
  explanation  String?    // Required if response is true
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  teamMember   TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  @@unique([teamMemberId, questionId])
  @@map("bad_actor_responses")
}

// ============================================
// CAP TABLE
// ============================================

model ShareClass {
  id              String          @id @default(cuid())
  companyId       String
  name            String          // Common, Preferred Series A, etc.
  type            String          @default("COMMON")
  authorizedShares BigInt
  parValue        Decimal?        @db.Decimal(10, 6)
  pricePerShare   Decimal?        @db.Decimal(10, 4)
  votingRights    Boolean         @default(true)
  liquidationPreference Decimal?  @db.Decimal(10, 2)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  capTableEntries CapTableEntry[]

  @@unique([companyId, name])
  @@map("share_classes")
}

model CapTableEntry {
  id              String     @id @default(cuid())
  companyId       String
  shareClassId    String
  shareholderName String
  shareholderType String     @default("OTHER")
  email           String?
  shares          BigInt
  pricePerShare   Decimal    @db.Decimal(10, 4)
  issueDate       DateTime?
  vestingSchedule String?
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  company    Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  shareClass ShareClass @relation(fields: [shareClassId], references: [id], onDelete: Cascade)

  @@map("cap_table_entries")
}

// ============================================
// RAISES & FILINGS
// ============================================

enum RegulationType {
  REG_CF
  REG_A_TIER_1
  REG_A_TIER_2
}

enum RaiseStatus {
  DRAFT
  FILED
  LIVE
  CLOSED
  CANCELLED
}

model Raise {
  id              String         @id @default(cuid())
  companyId       String
  regulation      RegulationType
  status          RaiseStatus    @default(DRAFT)
  
  // Offering Terms
  targetAmount    Decimal        @db.Decimal(12, 2)
  minimumAmount   Decimal?       @db.Decimal(12, 2)
  maximumAmount   Decimal?       @db.Decimal(12, 2)
  pricePerShare   Decimal?       @db.Decimal(10, 4)
  amountRaised    Decimal        @default(0) @db.Decimal(12, 2)
  
  // Dates
  startDate       DateTime?
  endDate         DateTime?
  filedAt         DateTime?
  qualifiedAt     DateTime?      // For Reg A+
  closedAt        DateTime?
  
  // Portal (for Reg CF)
  portalId        String?
  portalName      String?
  portalStatus    String?        @default("pending") // pending, applied, accepted, rejected
  portalContractUrl String?
  
  portal          Portal?        @relation(fields: [portalId], references: [id])

  // Financials
  priorRaisesAmount Decimal?     @default(0) @db.Decimal(12, 2)
  isFirstTimeIssuer Boolean?     @default(true)
  financialTier     String?      // Calculated requirement tier

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  company         Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  filings         Filing[]
  documents       Document[]
  financialStatements FinancialStatement[]
  ttwCampaign     TtwCampaign?
  investments     Investment[]
  vendorEngagements VendorEngagement[]
  audit           Audit?

  @@map("raises")
}

model Audit {
  id          String   @id @default(cuid())
  raiseId     String   @unique
  auditorId   String?
  status      String   @default("NOT_STARTED") // NOT_STARTED, IN_PROGRESS, DRAFT, FINAL
  fiscalYear  Int
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  raise       Raise    @relation(fields: [raiseId], references: [id], onDelete: Cascade)
  auditor     Vendor?  @relation(fields: [auditorId], references: [id])
  tasks       AuditTask[]

  @@map("audits")
}

model AuditTask {
  id          String   @id @default(cuid())
  auditId     String
  title       String
  description String?
  status      String   @default("PENDING") // PENDING, UPLOADED, VERIFIED
  documentId  String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  audit       Audit    @relation(fields: [auditId], references: [id], onDelete: Cascade)
  document    Document? @relation(fields: [documentId], references: [id])

  @@map("audit_tasks")
}

enum VendorType {
  ATTORNEY
  AUDITOR
  BROKER_DEALER
  MARKETING_AGENCY
  TRANSFER_AGENT
}

model Vendor {
  id          String     @id @default(cuid())
  name        String
  type        VendorType
  logoUrl     String?
  description String?
  location    String?
  website     String?
  fees        String?
  specialty   String?
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  engagements VendorEngagement[]

  @@map("vendors")
}

model VendorEngagement {
  id          String   @id @default(cuid())
  raiseId     String
  vendorId    String
  status      String   @default("PENDING") // PENDING, SENT, SIGNED, ACTIVE, COMPLETED
  quoteAmount Decimal? @db.Decimal(12, 2)
  notes       String?
  agreementUrl String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  raise       Raise    @relation(fields: [raiseId], references: [id], onDelete: Cascade)
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@map("vendor_engagements")
}

model Investment {
  id              String   @id @default(cuid())
  raiseId         String
  investorName    String
  amount          Decimal  @db.Decimal(12, 2)
  status          String   @default("CONFIRMED") // PENDING, CONFIRMED, CLEARED, CANCELLED
  investedAt      DateTime @default(now())
  
  raise           Raise    @relation(fields: [raiseId], references: [id], onDelete: Cascade)

  @@map("investments")
}

model TtwCampaign {
  id              String   @id @default(cuid())
  raiseId         String   @unique
  title           String
  description     String
  coverImageUrl   String?
  targetLaunch    DateTime?
  minInterest     Decimal? @db.Decimal(12, 2)
  shareToken      String   @unique @default(cuid())
  status          String   @default("DRAFT") // DRAFT, ACTIVE, ARCHIVED

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  raise           Raise    @relation(fields: [raiseId], references: [id], onDelete: Cascade)
  leads           TtwLead[]

  @@map("ttw_campaigns")
}

model TtwLead {
  id              String   @id @default(cuid())
  campaignId      String
  email           String
  name            String?
  interestAmount  Decimal? @db.Decimal(12, 2)
  message         String?
  status          String   @default("NEW") // NEW, CONTACTED, CONVERTED
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  campaign        TtwCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("ttw_leads")
}

enum FinancialStatementType {
  BALANCE_SHEET
  INCOME_STATEMENT
  CASH_FLOW
  EQUITY_CHANGES
  NOTES
  AUDIT_REPORT
}

enum FinancialStatementStatus {
  DRAFT
  UNDER_REVIEW
  CERTIFIED
}

model FinancialStatement {
  id          String @id @default(cuid())
  raiseId     String
  type        FinancialStatementType
  fileUrl     String
  periodStart DateTime?
  periodEnd   DateTime?
  status      FinancialStatementStatus @default(DRAFT)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  raise       Raise    @relation(fields: [raiseId], references: [id], onDelete: Cascade)

  @@map("financial_statements")
}

model Portal {
  id              String   @id @default(cuid())
  name            String
  logoUrl         String?
  website         String?
  cashFeePercent  Decimal  @db.Decimal(5, 2)
  equityFeePercent Decimal @db.Decimal(5, 2)
  features        String[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  raises          Raise[]

  @@map("portals")
}

enum FilingType {
  FORM_C
  FORM_C_U
  FORM_C_AR
  FORM_C_TR   // Termination of Reporting
  FORM_1_A
  FORM_1_A_A  // Amendment
  FORM_1_K
  FORM_1_SA
  FORM_1_U
}

enum FilingStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  COMMENTS_RECEIVED
  QUALIFIED
  REJECTED
}

model Filing {
  id                  String       @id @default(cuid())
  raiseId             String
  formType            FilingType
  status              FilingStatus @default(DRAFT)
  
  // Content stored as JSON
  contentJson         Json?
  
  // SEC tracking
  filedAt             DateTime?
  secAccessionNumber  String?
  qualificationDate   DateTime?
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  raise               Raise        @relation(fields: [raiseId], references: [id], onDelete: Cascade)
  secComments         SecComment[]

  @@map("filings")
}

model SecComment {
  id            String   @id @default(cuid())
  filingId      String
  letterDate    DateTime
  commentText   String
  responseDraft String?
  status        String   @default("OPEN") // OPEN, DRAFTED, RESOLVED
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  filing        Filing   @relation(fields: [filingId], references: [id], onDelete: Cascade)

  @@map("sec_comments")
}

// ============================================
// DOCUMENTS
// ============================================

enum DocumentCategory {
  FINANCIAL
  LEGAL
  FILING
  MARKETING
  OTHER
}

model Document {
  id          String           @id @default(cuid())
  companyId   String
  raiseId     String?
  category    DocumentCategory
  name        String
  url         String
  mimeType    String?
  size        Int?             // bytes
  version     Int              @default(1)
  uploadedBy  String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  raise       Raise?           @relation(fields: [raiseId], references: [id], onDelete: SetNull)

  @@map("documents")
}

// ============================================
// NOTIFICATIONS & AUDIT
// ============================================

enum NotificationType {
  DEADLINE
  ACTION_REQUIRED
  UPDATE
  INFO
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  body      String?
  actionUrl String?
  readAt    DateTime?
  createdAt DateTime         @default(now())

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String   // e.g., "filing.submitted", "document.uploaded"
  entity    String   // e.g., "Filing", "Document"
  entityId  String?
  metadata  Json?    // Additional context
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}
