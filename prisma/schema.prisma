// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  avatarUrl     String?
  emailVerified DateTime?
  mfaEnabled    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  companies     CompanyMember[]
  notifications Notification[]
  auditLogs     AuditLog[]

  @@map("users")
}

// ============================================
// COMPANY
// ============================================

enum EntityType {
  C_CORP
  S_CORP
  LLC
  PBC
  LP
  OTHER
}

model Company {
  id                  String     @id @default(cuid())
  legalName           String
  dba                 String?    // Doing Business As
  ein                 String?    // XX-XXXXXXX format
  entityType          EntityType
  stateOfIncorporation String
  formationDate       DateTime?
  fiscalYearEnd       String?    // e.g., "12-31"
  
  // Address
  streetAddress       String?
  city                String?
  state               String?
  zipCode             String?
  country             String     @default("US")
  
  // Branding
  logoUrl             String?
  website             String?
  description         String?
  
  // EDGAR Access
  edgarCik            String?    // 10-digit CIK
  edgarCcc            String?    // CCC (encrypted)
  edgarStatus         String?    @default("not_started") // not_started, pending, active
  
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relations
  members             CompanyMember[]
  teamMembers         TeamMember[]
  capTableEntries     CapTableEntry[]
  raises              Raise[]
  documents           Document[]

  @@map("companies")
}

enum CompanyRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

model CompanyMember {
  id        String      @id @default(cuid())
  userId    String
  companyId String
  role      CompanyRole @default(VIEWER)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("company_members")
}

// ============================================
// TEAM MEMBERS (Officers, Directors, Shareholders)
// ============================================

enum TeamMemberRole {
  OFFICER
  DIRECTOR
  SHAREHOLDER
  OFFICER_DIRECTOR
  ALL
}

model TeamMember {
  id                  String         @id @default(cuid())
  companyId           String
  name                String
  title               String?
  email               String?
  role                TeamMemberRole
  ownershipPercentage Decimal?       @db.Decimal(5, 2) // For 20%+ shareholders
  
  // Bad Actor Check
  badActorStatus      String         @default("pending") // pending, cleared, flagged
  badActorCompletedAt DateTime?
  
  // Sensitive data (encrypted in application layer)
  ssnEncrypted        String?
  
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  company             Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  badActorResponses   BadActorResponse[]

  @@map("team_members")
}

model BadActorResponse {
  id           String     @id @default(cuid())
  teamMemberId String
  questionId   String     // Reference to question number
  response     Boolean    // Yes = true (potential issue), No = false
  explanation  String?    // Required if response is true
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  teamMember   TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  @@unique([teamMemberId, questionId])
  @@map("bad_actor_responses")
}

// ============================================
// CAP TABLE
// ============================================

model ShareClass {
  id              String          @id @default(cuid())
  companyId       String
  name            String          // Common, Preferred Series A, etc.
  type            String          @default("COMMON")
  authorizedShares BigInt
  parValue        Decimal?        @db.Decimal(10, 6)
  pricePerShare   Decimal?        @db.Decimal(10, 4)
  votingRights    Boolean         @default(true)
  liquidationPreference Decimal?  @db.Decimal(10, 2)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  capTableEntries CapTableEntry[]

  @@unique([companyId, name])
  @@map("share_classes")
}

model CapTableEntry {
  id              String     @id @default(cuid())
  companyId       String
  shareClassId    String
  shareholderName String
  shareholderType String     @default("OTHER")
  email           String?
  shares          BigInt
  pricePerShare   Decimal    @db.Decimal(10, 4)
  issueDate       DateTime?
  vestingSchedule String?
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  company    Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  shareClass ShareClass @relation(fields: [shareClassId], references: [id], onDelete: Cascade)

  @@map("cap_table_entries")
}

// ============================================
// RAISES & FILINGS
// ============================================

enum RegulationType {
  REG_CF
  REG_A_TIER_1
  REG_A_TIER_2
}

enum RaiseStatus {
  DRAFT
  FILED
  LIVE
  CLOSED
  CANCELLED
}

model Raise {
  id              String         @id @default(cuid())
  companyId       String
  regulation      RegulationType
  status          RaiseStatus    @default(DRAFT)
  
  // Offering Terms
  targetAmount    Decimal        @db.Decimal(12, 2)
  minimumAmount   Decimal?       @db.Decimal(12, 2)
  maximumAmount   Decimal?       @db.Decimal(12, 2)
  pricePerShare   Decimal?       @db.Decimal(10, 4)
  amountRaised    Decimal        @default(0) @db.Decimal(12, 2)
  
  // Dates
  startDate       DateTime?
  endDate         DateTime?
  filedAt         DateTime?
  qualifiedAt     DateTime?      // For Reg A+
  closedAt        DateTime?
  
  // Portal (for Reg CF)
  portalId        String?
  portalName      String?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  company         Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  filings         Filing[]
  documents       Document[]

  @@map("raises")
}

enum FilingType {
  FORM_C
  FORM_C_U
  FORM_C_AR
  FORM_1_A
  FORM_1_A_A  // Amendment
  FORM_1_K
  FORM_1_SA
  FORM_1_U
}

enum FilingStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  COMMENTS_RECEIVED
  QUALIFIED
  REJECTED
}

model Filing {
  id                  String       @id @default(cuid())
  raiseId             String
  formType            FilingType
  status              FilingStatus @default(DRAFT)
  
  // Content stored as JSON
  contentJson         Json?
  
  // SEC tracking
  filedAt             DateTime?
  secAccessionNumber  String?
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  raise               Raise        @relation(fields: [raiseId], references: [id], onDelete: Cascade)

  @@map("filings")
}

// ============================================
// DOCUMENTS
// ============================================

enum DocumentCategory {
  FINANCIAL
  LEGAL
  FILING
  MARKETING
  OTHER
}

model Document {
  id          String           @id @default(cuid())
  companyId   String
  raiseId     String?
  category    DocumentCategory
  name        String
  url         String
  mimeType    String?
  size        Int?             // bytes
  version     Int              @default(1)
  uploadedBy  String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  raise       Raise?           @relation(fields: [raiseId], references: [id], onDelete: SetNull)

  @@map("documents")
}

// ============================================
// NOTIFICATIONS & AUDIT
// ============================================

enum NotificationType {
  DEADLINE
  ACTION_REQUIRED
  UPDATE
  INFO
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  body      String?
  actionUrl String?
  readAt    DateTime?
  createdAt DateTime         @default(now())

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String   // e.g., "filing.submitted", "document.uploaded"
  entity    String   // e.g., "Filing", "Document"
  entityId  String?
  metadata  Json?    // Additional context
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}
